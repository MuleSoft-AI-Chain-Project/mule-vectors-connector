<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit" xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd">
	<munit:config minMuleVersion="4.9.4" name="test-embedding-operations.xml">
		<munit:parameterizations >
			<munit:parameterization name="config-embedding-einstein" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingEinsteinConfig" />
					<munit:parameter propertyName="textModelName" value="sfdc_ai__DefaultAzureOpenAITextEmbeddingAda_002" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="false" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-azureopenai" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingAzureOpenAIConfig" />
					<munit:parameter propertyName="textModelName" value="text-embedding-ada-002" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="false" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-nomic" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingNomicConfig" />
					<munit:parameter propertyName="textModelName" value="nomic-embed-text-v1" />
					<munit:parameter propertyName="multimodalModelName" value="nomic-embed-vision-v1" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="true" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-openai" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingOpenAIConfig" />
					<munit:parameter propertyName="textModelName" value="text-embedding-ada-002" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="false" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-huggingface" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingHuggingFaceConfig" />
					<munit:parameter propertyName="textModelName" value="sentence-transformers/all-MiniLM-L6-v2" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="false" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-mistralai" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingMistralAIConfig" />
					<munit:parameter propertyName="textModelName" value="mistral-embed" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="false" />
				</munit:parameters>
			</munit:parameterization>
			<munit:parameterization name="config-embedding-visionai" >
				<munit:parameters >
					<munit:parameter propertyName="config" value="embeddingAzureAIVisionConfig" />
					<munit:parameter propertyName="textModelName" value="2023-04-15" />
					<munit:parameter propertyName="multimodalModelName" value="2023-04-15" />
					<munit:parameter propertyName="maxSegmentSize" value="1000" />
					<munit:parameter propertyName="maxOverlapSize" value="100" />
					<munit:parameter propertyName="isMultimodal" value="true" />
				</munit:parameters>
			</munit:parameterization>
		</munit:parameterizations>
	</munit:config>
	<munit:test name="embedding-operations-generate-from-text" doc:id="fa0c3ab8-5d99-40db-a0e0-d5b6f6c5b4dd" >
		<munit:execution >
			<flow-ref doc:name="embedding-operations-generate-from-text-exec" doc:id="a5b87491-2254-4703-b92b-6bfb7ec11442" name="embedding-operations-generate-from-text-exec"/>
		</munit:execution>
		<munit:validation >
			<flow-ref doc:name="embedding-operations-validate-generate-from" doc:id="82679aa1-a5cb-4b02-a3a2-220366b6dcd7" name="embedding-operations-validate-generate-from"/>
		</munit:validation>
	</munit:test>
	<munit:test name="embedding-operations-generate-from-media" doc:id="3201a90d-e628-4604-80f5-64b5d38bdc12" ignore="#[!p('isMultimodal')]">
		<munit:execution >
			<flow-ref doc:name="embedding-operations-generate-from-document-exec" doc:id="f37eb7e1-9363-49c1-b7a8-0a91003acffd" name="embedding-operations-generate-from-media-exec"/>
		</munit:execution>
		<munit:validation >
			<flow-ref doc:name="embedding-operations-validate-generate-from" doc:id="b06f8603-2219-4df8-bc93-947fbbf02a37" name="embedding-operations-validate-generate-from" />
		</munit:validation>
	</munit:test>
	<sub-flow name="embedding-operations-validate-generate-from" doc:id="3df16ae4-e3f7-4134-9686-8a21686d3f1a" >
		<munit-tools:assert-that doc:name="Assert that payload is not null" doc:id="5d1a4133-28fc-4154-9499-b73dee3d4e41" message="Payload is null" expression="#[payload]" is="#[MunitTools::notNullValue()]" />
		<munit-tools:assert-that doc:name="Assert that embeddings is not null" doc:id="d99d21e5-2dc1-4d4e-9cba-3cbc2752cab5" message="Payload is null" expression="#[payload.embeddings]" is="#[MunitTools::notNullValue()]" />
		<munit-tools:assert-that doc:name="Assert that text-segments is not null" doc:id="f4ffe2da-fb79-4211-bd06-2302afa2bad6" message="Payload is null" expression='#[payload."text-segments"]' is="#[MunitTools::notNullValue()]" />
		<munit-tools:assert-that doc:name="Assert that dimension is not null and greater than 0" doc:id="643138af-283d-4196-9a52-9b14e05225bc" message="Invalid dimension" expression="#[payload.dimension]" is="#[MunitTools::greaterThan(0)]"/>
		<munit-tools:assert-equals doc:name="Assert dimension match embedding size." doc:id="df76786c-3cc9-4204-b05e-0222d9aa541d" actual="#[sizeOf(payload.embeddings[0])]" expected="#[payload.dimension]" message="Model dimension do not match embedding size."/>
		<munit-tools:assert-equals doc:name="Assert number of embedding vectors match number of text segments." doc:id="0c381af8-7b15-400d-b4a9-08e2f010198a" actual="#[sizeOf(payload.embeddings)]" expected='#[sizeOf(payload."text-segments")]' message="Number of embedding vectors do not match number of text segments." />
	</sub-flow>

</mule>
